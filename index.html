<!DOCTYPE html>
<html lang="ko">
<head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<meta charset="UTF-8">
<title>ìƒíƒœì•Œë¼ë¯¸ v6.7</title>
<style>
    :root {
        --bg-color: #f0f2f5;
        --text-color: #333333;
        --accent-color: #5865F2;
        --custom-color: #2ecc71;
        --card-bg: #ffffff;
        --border-radius: 16px;
    }

    body.dark-mode {
        --bg-color: #1e1f22;
        --text-color: #dbdee1;
        --card-bg: #2b2d31;
    }

    body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
        margin: 0;
        padding: 20px;
        transition: 0.3s;
    }

    .header-area { text-align: center; margin-top: 40px; margin-bottom: -10px; }
    .header-area h1 { font-size: 2.2rem; color: var(--accent-color); margin-bottom: 5px; letter-spacing: -1px; }
    .header-area .developer { font-size: 0.9rem; color: #888; font-weight: 500; }

    h2 { margin-top: 0; font-size: 1.4rem; color: var(--accent-color); margin-bottom: 20px; }

    .main-grid { display: flex; flex-wrap: wrap; gap: 20px; max-width: 1400px; margin: 40px auto; justify-content: center; }
    .grid-column { flex: 1 1 350px; display: flex; flex-direction: column; }
    .card { background: var(--card-bg); border-radius: var(--border-radius); padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 100%; box-sizing: border-box; display: flex; flex-direction: column; }

    input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; outline: none; font-size: 14px; }
    .timer-input { width: 100px; display: inline-block; background-color: #fffbe6; margin-right: 5px; }

    button { padding: 10px 12px; margin: 3px; font-size: 13px; cursor: pointer; border-radius: 8px; border: none; background-color: #f1f3f5; transition: 0.2s; }
    button:hover { background-color: #e9ecef; transform: translateY(-2px); }
    .btn-primary { background-color: var(--accent-color); color: white; }
    .btn-success { background-color: var(--custom-color); color: white; }
    .btn-back { background-color: #d1d8ff !important; font-weight: bold; width: 100%; margin: 15px 0 0 0; font-size: 15px; padding: 15px; }

    .time-chip { background-color: #ffeaa7; border: 1px solid #fdcb6e; font-weight: 600; }
    .time-chip:hover { background-color: #fab1a0; }

    #status-display { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 20px; }
    .status-icon { font-size: 5.5rem; margin-bottom: 25px; }
    #display-text { font-size: 1.5rem; font-weight: bold; line-height: 1.6; text-align: center; }
    #countdown-display { font-size: 1.5rem; color: #e74c3c; margin-top: 25px; font-weight: 800; background: #fff5f5; padding: 10px 20px; border-radius: 30px; }

    #status-history { max-height: 250px; overflow-y: auto; text-align: left; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 10px; flex-grow: 1; }
    .dark-mode #status-history { background: #35373c; }
    .history-item { padding: 8px; border-bottom: 1px solid #eee; font-size: 0.85rem; }

    .warning-box { background-color: #fff5f5; border-left: 4px solid #ff8787; padding: 12px; margin-top: 15px; font-size: 0.8rem; text-align: left; color: #e03131; }
    .dark-mode .warning-box { background-color: #3b2525; color: #ffc9c9; }

    .theme-btn { position: fixed; top: 20px; right: 20px; background-color: var(--accent-color); color: white; width: 45px; height: 45px; border-radius: 50%; z-index: 1000; }

    /* ê°€ì´ë“œ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
}

.modal-content {
    background-color: var(--card-bg);
    margin: 5% auto;
    padding: 30px;
    border-radius: var(--border-radius);
    width: 80%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    position: relative;
    border: 2px solid var(--accent-color);
}

.close-btn {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 24px;
    cursor: pointer;
    color: #888;
}

.guide-btn {
    font-size: 0.9rem;
    padding: 5px 12px;
    vertical-align: middle;
    margin-left: 10px;
    background-color: #fff;
    border: 1px solid var(--accent-color);
    color: var(--accent-color);
    font-weight: bold;
}

.guide-btn:hover {
    background-color: var(--accent-color);
    color: #fff;
}

/* ëª¨ë‹¬ ë‚´ë¶€ ìº¬ë£¨ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
.modal-kyaru-box {
    background: rgba(255, 118, 117, 0.1);
    border-radius: 12px;
    padding: 15px;
    border: 1px dashed #ff7675;
    margin-top: 15px;
}

</style>
</head>
<body>

<button class="theme-btn" onclick="toggleTheme()">ğŸŒ“</button>

<div class="header-area">
    <h1>
    ğŸ“¡ ë””ìŠ¤ì½”ë“œ ìƒíƒœì•Œë¼ë¯¸ v6.7
    <button class="guide-btn" onclick="openModal()">ì‚¬ìš© ê°€ì´ë“œ ğŸ“–</button>
    <button class="guide-btn" style="border-color: #2ecc71; color: #2ecc71;" onclick="openStatsModal()">í†µê³„ ë³´ê¸° ğŸ“Š</button>
</h1>
    <div class="developer">Developer by. ê¹€ìœ¤ê²¸</div>
</div>

<div id="guideModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>

        <h2>ğŸ“˜ ì „ì²´ ì‚¬ìš© ì„¤ëª…ì„œ</h2>

        <div style="line-height: 1.8;">
            <strong>â± íƒ€ì´ë¨¸ & ìƒíƒœ ì„¤ì •</strong>
            <ul style="font-size: 0.9rem; padding-left: 20px;">
                <li>ë‹‰ë„¤ì„ ì…ë ¥ í›„ ìƒíƒœ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë””ìŠ¤ì½”ë“œì— ì¦‰ì‹œ ì „ì†¡ë©ë‹ˆë‹¤.</li>
                <li>ì‹œê°„ì„ ì„ íƒí•˜ë©´ ìë™ ë³µê·€ íƒ€ì´ë¨¸ê°€ ì‘ë™í•˜ë©°, ë¸Œë¼ìš°ì €ê°€ ì¼œì ¸ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</li>
                <li>ìƒˆë¡œê³ ì¹¨í•´ë„ íƒ€ì´ë¨¸ëŠ” ìœ ì§€ë˜ì§€ë§Œ, ì¿ í‚¤/ì €ì¥ì†Œ ì‚­ì œ ì‹œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</li>
                <li><b>ì•Œë¦¼ ê¶Œí•œ:</b> ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ ì™¼ìª½ ìë¬¼ì‡ ë¥¼ ëˆŒëŸ¬ ì•Œë¦¼ì„ í—ˆìš©í•´ ì£¼ì„¸ìš”!</li>
            </ul>

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <div class="modal-kyaru-box">
                <strong>ğŸ± ìº¬ë£¨ë‘ ëŒ€í™”í•˜ëŠ” ë²• (ë˜‘ë°”ë¡œ ì½ì–´!)</strong>
                <ul style="font-size: 0.9rem; padding-left: 20px;">
                    <li><b>ì§ˆë¬¸ ë˜ì§€ê¸°:</b> ê¶ê¸ˆí•œ ê±¸ ì ê³  ì—”í„°ë¥¼ ì³! ë‹‰ë„¤ì„ì€ ê¼­ ë¯¸ë¦¬ ì¨ë‘¬ì•¼ í•´.</li>
                    <li><b>ê¸°ë‹¤ë¦¼:</b> ë‚´ê°€ 'ìƒê° ì¤‘'ì´ë©´ ìµœëŒ€ 10ë²ˆ ì¬ì‹œë„í•˜ë‹ˆê¹Œ ì°½ ë‹«ì§€ ë§ê³  ê¸°ë‹¤ë ¤!</li>
                    <li><b>ì„œë²„ ìƒíƒœ:</b> ë¬´ë£Œ ì„œë²„ë¼ ë‚´ê°€ ì ë“¤ì–´ ìˆì„ ìˆ˜ ìˆì–´. ê¹¨ì–´ë‚  ë•Œê¹Œì§€ 30ì´ˆë§Œ ì°¸ì•„!</li>
                    <li>ë§íˆ¬ëŠ” ê¹Œì¹ í•´ë„ ì •ë‹µì€ ì¹œì ˆí•˜ê²Œ ì•Œë ¤ì¤„ í…Œë‹ˆ ê³ ë§ˆìš´ ì¤„ ì•Œë¼êµ¬!</li>
                </ul>
            </div>
        </div>

        <div style="text-align: center; margin-top: 25px;">
            <button class="btn-primary" onclick="closeModal()" style="width: 100%;">ì•Œì•˜ì–´, ìº¬ë£¨ì¨©! (ë‹«ê¸°)</button>
        </div>
    </div>
</div>

<div id="statsModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeStatsModal()">&times;</span>
        <h2>ğŸ“Š ë‚´ ìƒíƒœ ì‚¬ìš© í†µê³„</h2>
        <p style="font-size: 0.8rem; color: #888;">ì§€ê¸ˆê¹Œì§€ ë„¤ê°€ ê°€ì¥ ë§ì´ ì„ íƒí•œ ìƒíƒœë“¤ì´ì•¼!</p>

        <div style="width: 100%; margin-top: 20px;">
            <canvas id="statsChart"></canvas>
        </div>

        <div style="text-align: center; margin-top: 25px;">
            <button class="btn-primary" onclick="closeStatsModal()" style="width: 100%;">í™•ì¸í–ˆì–´!</button>
        </div>
    </div>
</div>

<div class="main-grid">
    <div class="grid-column">
        <div class="card">
            <h2>ğŸ‘¤ ë‚´ ì„¤ì •</h2>
            <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" oninput="saveNickname()">

            <div style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <strong>â± ë³µê·€ ì‹œê°„ ì„ íƒ (ë¶„)</strong>
                    <button class="time-chip" style="background-color: #ff7675; color: white; border: none; margin: 0; font-size: 11px; padding: 5px 10px;" onclick="resetTimeValue()">ì´ˆê¸°í™” ğŸ”„</button>
                </div>
                <div style="margin: 10px 0;">
                    <button class="time-chip" onclick="setTimeValue(3)">3ë¶„</button>
                    <button class="time-chip" onclick="setTimeValue(5)">5ë¶„</button>
                    <button class="time-chip" onclick="setTimeValue(10)">10ë¶„</button>
                    <button class="time-chip" onclick="setTimeValue(20)">20ë¶„</button>
                    <button class="time-chip" onclick="setTimeValue(30)">30ë¶„</button>
                    <button class="time-chip" onclick="setTimeValue(60)">60ë¶„</button>
                </div>
                <div style="display: flex; align-items: center; margin-top: 10px;">
                    <input type="number" id="return-time" class="timer-input" placeholder="ì§ì ‘ ì…ë ¥">
                    <span>ë¶„ í›„ ë³µê·€</span>
                </div>
            </div>

            <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 10px; border: 1px dashed #ddd;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
        <span style="font-size: 0.8rem; font-weight: bold; color: #666;">â³ íƒ€ì´ë¨¸ ì—°ì¥í•˜ê¸°</span>
        <button onclick="document.getElementById('extend-direct-time').value=''" style="background: #ff7675; color: white; border: none; margin: 0; font-size: 10px; padding: 2px 6px;">ì´ˆê¸°í™” ğŸ”„</button>
    </div>

    <button onclick="extendTime(1)" style="background: #e1f5fe; color: #0288d1; font-size: 11px;">+1ë¶„</button>
    <button onclick="extendTime(3)" style="background: #e1f5fe; color: #0288d1; font-size: 11px;">+3ë¶„</button>
    <button onclick="extendTime(5)" style="background: #e1f5fe; color: #0288d1; font-size: 11px;">+5ë¶„</button>
    <button onclick="extendTime(10)" style="background: #e1f5fe; color: #0288d1; font-size: 11px;">+10ë¶„</button>
    <button onclick="extendTime(30)" style="background: #e1f5fe; color: #0288d1; font-size: 11px;">+30ë¶„</button>
                <button onclick="extendTime(60)" style="background: #e1f5fe; color: #0288d1; font-size: 11px;">+60ë¶„</button>

    <div style="display: flex; align-items: center; margin-top: 8px;">
        <input type="number" id="extend-direct-time" class="timer-input" style="width: 70px; height: 30px; margin: 0 5px 0 0;" placeholder="ë¶„">
        <button class="btn-success" style="padding: 5px 10px; font-size: 11px; margin: 0;" onclick="extendDirect()">ì—°ì¥í•˜ê¸°</button>
    </div>
</div>

            <hr style="margin: 25px 0; border: 0; border-top: 1px solid #eee;">

            <h2>ğŸ“ ë¹ ë¥¸ ìƒíƒœ ì„ íƒ</h2>
            <div class="btn-group">
                <button onclick="send('eat', 'ë°¥')">ğŸš ë°¥</button>
                <button onclick="send('toilet', 'í™”ì¥ì‹¤')">ğŸš½ í™”ì¥ì‹¤</button>
                <button onclick="send('coffee', 'ì»¤í”¼')">â˜• ì»¤í”¼</button>
                <button onclick="send('shop', 'ì‡¼í•‘')">ğŸ›’ ì‡¼í•‘</button>
                <button onclick="send('outing', 'ì™¸ì¶œ')">ğŸƒ ì™¸ì¶œ</button>
                <button onclick="send('cigarette', 'ë‹´ë°°')">ğŸš¬ ë‹´ë°°</button>
                <button onclick="send('nap', 'ì ')">ğŸ˜´ ì </button>
                <button onclick="send('back', 'ë³µê·€')" class="btn-back">âœ… ì§€ê¸ˆ ìë¦¬ë¡œ ë³µê·€í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div class="grid-column">
        <div class="card">
            <h2>âœ¨ ì»¤ìŠ¤í…€ & ê¸°ë¡</h2>
            <div style="margin-bottom: 20px;">
                <label style="font-size: 0.9rem; font-weight: bold;">ë‚˜ë§Œì˜ ìƒíƒœ ì…ë ¥</label>
                <input type="text" id="custom-status" placeholder="íšŒì˜, ì‚°ì±… ë“± ì§ì ‘ ì‘ì„±" onkeypress="if(event.keyCode==13) sendCustomStatus()">
                <button class="btn-success" style="width:100%;" onclick="sendCustomStatus()">ìƒíƒœ ì—…ë°ì´íŠ¸</button>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="font-size: 0.9rem; font-weight: bold;">ë©”ì‹œì§€ë§Œ ì „ì†¡</label>
                <input type="text" id="direct-msg" placeholder="ë‹¨ìˆœ ë©”ì‹œì§€ ì…ë ¥" onkeypress="if(event.keyCode==13) sendDirectMsg()">
                <button class="btn-primary" style="width:100%;" onclick="sendDirectMsg()">ë©”ì‹œì§€ ë³´ë‚´ê¸°</button>
            </div>
            <div class="history-title" style="font-weight: bold; margin-bottom: 5px;">ğŸ“œ í™œë™ ê¸°ë¡</div>
            <div id="status-history"></div>
        </div>
    </div>

    <div class="grid-column">
    <div class="card" style="border: 2px solid var(--accent-color); margin-bottom: 20px;">
        <h2>ğŸ“¡ ì‹¤ì‹œê°„ ìƒíƒœ</h2>
        <div id="status-display">
            <span class="status-icon" id="display-icon">â“</span>
            <span id="display-text">ìƒíƒœë¥¼ ì„ íƒí•˜ë©´<br>ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤!</span>
            <div id="countdown-display" style="display: none;"></div>
        </div>
    </div>

    <div class="card" style="border: 2px solid #ff7675;">
    <h2>ğŸ± ìº¬ë£¨ì—ê²Œ ì§ˆë¬¸í•˜ê¸°</h2>
    <div style="font-size: 0.8rem; color: #888; margin-bottom: 10px;">
        ì¸¤ë°ë ˆ ìº¬ë£¨ì¨©ì—ê²Œ ë§ì„ ê±¸ì–´ë³´ì„¸ìš”!
    </div>

    <input type="text" id="kyaru-input" placeholder="ì•¼! ë­ ë¬¼ì–´ë³¼ ê±°ë¼ë„ ìˆì–´? (Enter)" onkeypress="if(event.keyCode==13) askKyaru()">
    <button class="btn-primary" style="width: 100%; background-color: #ff7675;" onclick="askKyaru()">ì§ˆë¬¸ ë˜ì§€ê¸°</button>

    <div id="kyaru-loading" style="display: none; text-align: center; margin-top: 15px;">
        <img src="{{ url_for('static', filename='kyal.gif') }}" alt="ìƒê°ì¤‘ì¸ ìº¬ë£¨" style="width: 100px; border-radius: 50%;">
        <p style="font-size: 0.8rem; color: #ff7675; font-weight: bold;">ìº¬ë£¨ê°€ ë¨¸ë¦¬ë¥¼ ì§œë‚´ê³  ìˆì–´...!</p>
    </div>

    <div id="kyaru-response" style="margin-top: 15px; padding: 12px; background: #fff5f5; border-radius: 12px; font-size: 0.9rem; min-height: 50px; display: none; border: 1px dashed #ff7675;">
        <strong>ğŸ± ìº¬ë£¨:</strong> <span id="kyaru-text"></span>
    </div>
</div>
</div>
</div>

    <p style="text-align: center; margin-top: 20px; opacity: 0.6; font-size: 0.75rem;">Â© 2026 ê¹€ìœ¤ê²¸. All rights reserved.</p>
</div>

<script>
let countdownInterval;
let myChart = null;
const DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1458597916955381800/FjIDySDIfP-kZp1udUCL7o6pQN0pv7yJyz0KLiYcLrEm6FyrK10Z5Z9XJnNN0JpRGpxf";
// í…ŒìŠ¤íŠ¸ìš© https://discord.com/api/webhooks/1458643194270056489/Ec0iQFL8m-sCdPC7AI29wqq0Cq_LDiLeI8Z5Rsp0Yrh7UEY8ysftSdEF-NeYdKkTQBBp
// ì‹¤ì œ https://discord.com/api/webhooks/1458597916955381800/FjIDySDIfP-kZp1udUCL7o6pQN0pv7yJyz0KLiYcLrEm6FyrK10Z5Z9XJnNN0JpRGpxf
window.onload = function() {
    const savedName = localStorage.getItem('userNickname');
    if (savedName) document.getElementById('nickname').value = savedName;
    if (Notification.permission !== 'granted') Notification.requestPermission();
    restoreStatus();
}

function saveNickname() { localStorage.setItem('userNickname', document.getElementById('nickname').value); }
function toggleTheme() { document.body.classList.toggle('dark-mode'); }
function resetTimeValue() { document.getElementById('return-time').value = ""; }
function setTimeValue(min) { document.getElementById('return-time').value = min; }

function getNowFormatted() {
    const now = new Date();
    return `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
}

// ğŸ’¬ ë‹¨ìˆœ ë©”ì‹œì§€ ì „ì†¡ (Embed ì ìš©)
function sendDirectMsg() {
    const nickname = document.getElementById('nickname').value.trim();
    const content = document.getElementById('direct-msg').value.trim();
    if (!nickname || !content) return alert("ë‹‰ë„¤ì„ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");

    const timestamp = getNowFormatted();
    const embedData = {
        embeds: [{
            author: { name: nickname },
            description: `ğŸ’¬ ${content}`,
            color: 5814783,
            footer: { text: `ë°œì†¡ ì‹œê°: ${timestamp}` }
        }]
    };

    fetch(DISCORD_WEBHOOK, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(embedData) });
    addHistoryItem(nickname, `ğŸ’¬ ${content}`, timestamp);
    document.getElementById('direct-msg').value = "";
}

function sendCustomStatus() {
    const text = document.getElementById('custom-status').value.trim();
    if (!text) return alert("ìƒíƒœ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
    send('etc', text);
}

function getActionMessage(action, customText = "") {
    const messages = { eat: "ë°¥ ë¨¹ìœ¼ëŸ¬ ê°”ì–´ìš”!", toilet: "ì ì‹œ í™”ì¥ì‹¤ì— ê°”ì–´ìš”!", coffee: "ì»¤í”¼ í•œ ì” ë§ˆì‹œê³  ì˜¬ê²Œìš”!", shop: "ì ê¹ ì‡¼í•‘í•˜ëŸ¬ ë‚˜ê°”ì–´ìš”!", outing: "ì ì‹œ ì™¸ì¶œ ì¤‘ì´ì—ìš”!", cigarette: "ë‹´ë°° í•œ ëŒ€ í”¼ìš°ê³  ì˜¬ê²Œìš”!", nap: "ê¿€ì  ìëŸ¬ ê°”ì–´ìš”!", back: "ìë¦¬ë¡œ ëŒì•„ì™”ì–´ìš”!", etc: `${customText} ì¤‘ì´ì—ìš”!` };
    return messages[action] || "í™œë™ ì¤‘ì´ì—ìš”!";
}

let isProcessingBack = false; // ë³µê·€ ì²˜ë¦¬ê°€ ì§„í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ëŠ” ë³€ìˆ˜

function send(action, statusName) {
    const nickname = document.getElementById('nickname').value.trim();
    if (!nickname) { alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }

    // --- ğŸš¨ [ì¶”ê°€] ì¤‘ë³µ ìƒíƒœ ë°©ì§€ ë¡œì§ ---
    // 'ë³µê·€(back)' ë²„íŠ¼ì´ ì•„ë‹Œ ë‹¤ë¥¸ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ, ì´ë¯¸ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì°¨ë‹¨!
    const currentData = localStorage.getItem('currentStatus');
    if (action !== 'back' && currentData) {
        const statusObj = JSON.parse(currentData);
        alert(`ğŸ± ìº¬ë£¨: ì•¼! ë„ˆ ì§€ê¸ˆ ì´ë¯¸ [${statusObj.statusName}] ì¤‘ì´ì–ì•„!\ní•˜ë‚˜ë¼ë„ ì œëŒ€ë¡œ ëë‚´ê³  ë‹¤ë¥¸ ê±¸ í•˜ë€ ë§ì´ì•¼! í¥!\n(ë°”ê¾¸ê³  ì‹¶ìœ¼ë©´ 'ë³µê·€í•˜ê¸°' ë²„íŠ¼ì„ ë¨¼ì € ëˆŒëŸ¬!)`);
        return; // ì—¬ê¸°ì„œ í•¨ìˆ˜ë¥¼ ëë‚´ì„œ ì•„ë˜ ì½”ë“œê°€ ì‹¤í–‰ë˜ì§€ ì•Šê²Œ í•©ë‹ˆë‹¤.
    }

    const returnTimeValue = document.getElementById('return-time').value.trim();
    const returnTime = returnTimeValue ? parseInt(returnTimeValue) : null;

    // [ì¶”ê°€] ë³µê·€ ì¤‘ë³µ ë°©ì§€ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
    if (action === 'back') {
        if (isProcessingBack) return;
        isProcessingBack = true;
        setTimeout(() => { isProcessingBack = false; }, 3000);
    }

    // íƒ€ì´ë¨¸ ë° í™”ë©´ ì´ˆê¸°í™”
    clearInterval(countdownInterval);
    document.getElementById('countdown-display').style.display = "none";

    const design = {
        eat: { icon: "ğŸš", color: 16753920 },
        toilet: { icon: "ğŸš½", color: 3447003 },
        coffee: { icon: "â˜•", color: 10181046 },
        shop: { icon: "ğŸ›’", color: 15844367 },
        outing: { icon: "ğŸƒ", color: 15105570 },
        cigarette: { icon: "ğŸš¬", color: 9807270 },
        nap: { icon: "ğŸ˜´", color: 15548997 },
        back: { icon: "âœ…", color: 3066993 },
        etc: { icon: "âœ¨", color: 5814783 }
    };

    const info = design[action] || design.etc;
    const statusMsg = getActionMessage(action, statusName);
    const timestamp = getNowFormatted();

    // ì˜ˆìƒ ë³µê·€ ì‹œê° ê³„ì‚°
    let estimatedReturnMsg = "ì¦‰ì‹œ/ì—†ìŒ";
    if (action !== 'back' && returnTime) {
        const now = new Date();
        now.setMinutes(now.getMinutes() + returnTime);
        const hour = String(now.getHours()).padStart(2, '0');
        const min = String(now.getMinutes()).padStart(2, '0');
        estimatedReturnMsg = `${returnTime}ë¶„ í›„ (${hour}:${min} ì˜ˆì •)`;
    }

    // ë””ìŠ¤ì½”ë“œ ì „ì†¡ ë°ì´í„°
    const embedData = {
        embeds: [{
            title: `${info.icon} ${nickname}ë‹˜ì˜ ìƒíƒœ`,
            color: info.color,
            description: `${statusMsg}`,
            fields: [
                { name: "ë³µê·€ ì˜ˆì • ì‹œê°", value: estimatedReturnMsg, inline: false }
            ],
            footer: { text: `ë°œìƒ ì‹œê°: ${timestamp}` }
        }]
    };

    fetch(DISCORD_WEBHOOK, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(embedData)
    });

    updateUI(nickname, info.icon, statusName, timestamp, statusMsg);

    // ì €ì¥ ë° íƒ€ì´ë¨¸ ì‹¤í–‰
    if (action !== 'back') {
        updateStatistics(statusName);
        const expireTime = returnTime ? Date.now() + (returnTime * 60000) : null;
        localStorage.setItem('currentStatus', JSON.stringify({ nickname, icon: info.icon, statusName, expireTime }));
        if (returnTime) {
            document.getElementById('countdown-display').style.display = "block";
            startTimer(returnTime * 60);
        }
    } else {
        localStorage.removeItem('currentStatus');
        document.getElementById('return-time').value = "";
        document.getElementById('countdown-display').innerText = "";
    }
}

function updateUI(nickname, icon, statusName, timestamp, msg) {
    document.getElementById('display-icon').innerText = icon;
    document.getElementById('display-text').innerHTML = `
        <span style="color:#5865F2; font-size:1.1rem;">${nickname}</span><br>
        <span style="color:#e74c3c;">[${statusName}]</span> ì¤‘<br>
        <small style="font-size: 0.85rem; color: #777;">(${msg})</small>
    `;
    addHistoryItem(nickname, msg, timestamp);
}

function updateStatistics(statusName) {
    let stats = JSON.parse(localStorage.getItem('statusStats') || '{}');
    stats[statusName] = (stats[statusName] || 0) + 1;
    localStorage.setItem('statusStats', JSON.stringify(stats));
}

// ê¸°ì¡´ send í•¨ìˆ˜ ì•ˆì—ì„œ í˜¸ì¶œ (actionì´ 'back'ì´ ì•„ë‹ ë•Œë§Œ ì €ì¥í•˜ëŠ” ê±¸ ì¶”ì²œ!)
if (action !== 'back') {
    updateStatistics(statusName);
}

function addHistoryItem(nickname, msg, timestamp) {
    const historyBox = document.getElementById('status-history');
    const newRecord = `<div class="history-item"><small style="color:gray;">${timestamp}</small> <strong>${nickname}</strong>: ${msg}</div>`;
    historyBox.innerHTML = newRecord + historyBox.innerHTML;
}

function startTimer(secondsTotal) {
    let secondsLeft = Math.floor(secondsTotal);
    if (countdownInterval) clearInterval(countdownInterval);

    countdownInterval = setInterval(() => {
        secondsLeft--;
        if (secondsLeft <= 0) {
            clearInterval(countdownInterval);
            if (Notification.permission === 'granted') new Notification("ë³µê·€ ì•Œë¦¼", { body: "ë³µê·€ ì‹œê°„ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!" });

            send('back', 'ìë™ ë³µê·€');
            return;
        }
        const m = Math.floor(secondsLeft / 60);
        const s = secondsLeft % 60;
        document.getElementById('countdown-display').innerText = `â³ ë³µê·€ê¹Œì§€ ${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')} ë‚¨ìŒ`;
    }, 1000);
}

function restoreStatus() {
    const data = localStorage.getItem('currentStatus');
    if (!data) return;
    const { nickname, icon, statusName, expireTime } = JSON.parse(data);
    const now = Date.now();
    if (expireTime && now > expireTime) { localStorage.removeItem('currentStatus'); return; }
    updateUI(nickname, icon, statusName, getNowFormatted(), "ìƒíƒœ ë³µêµ¬ë¨");
    if (expireTime) {
        document.getElementById('countdown-display').style.display = "block";
        startTimer((expireTime - now) / 1000);
    }
}

    function extendTime(min) {
    const data = localStorage.getItem('currentStatus');
    if (!data) {
        alert("í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ íƒ€ì´ë¨¸ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒíƒœë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!");
        return;
    }

    const statusData = JSON.parse(data);
    const now = Date.now();

    // 1. ìƒˆë¡œìš´ ë§Œë£Œ ì‹œê°„ ê³„ì‚°
    let baseTime = (statusData.expireTime && statusData.expireTime > now)
                   ? statusData.expireTime
                   : now;

    const newExpireTime = baseTime + (min * 60000);
    const remainingSeconds = Math.floor((newExpireTime - now) / 1000);

    // --- ğŸ’¡ [ì¶”ê°€] ìƒˆë¡œìš´ ë³µê·€ ì˜ˆì • ì‹œê° ê³„ì‚° ---
    const targetDate = new Date(newExpireTime);
    const targetHour = String(targetDate.getHours()).padStart(2, '0');
    const targetMin = String(targetDate.getMinutes()).padStart(2, '0');
    const estimatedTimeStr = `${targetHour}:${targetMin} ì˜ˆì •`;
    // ------------------------------------------

    // 2. ë°ì´í„° ì—…ë°ì´íŠ¸ ë° íƒ€ì´ë¨¸ ì¬ì‹œì‘
    statusData.expireTime = newExpireTime;
    localStorage.setItem('currentStatus', JSON.stringify(statusData));

    clearInterval(countdownInterval);
    document.getElementById('countdown-display').style.display = "block";
    startTimer(remainingSeconds);

    // 3. ë””ìŠ¤ì½”ë“œì— ì—°ì¥ ì•Œë¦¼ ì „ì†¡ (ë³µê·€ ì˜ˆì • ì‹œê° í¬í•¨)
    const timestamp = getNowFormatted();
    const embedData = {
        embeds: [{
            title: `â³ ì‹œê°„ ì—°ì¥ ì•Œë¦¼`,
            color: 3447003, // íŒŒë€ìƒ‰
            description: `${statusData.nickname}ë‹˜ì˜ ë³µê·€ ì‹œê°„ì´ ${min}ë¶„ ì—°ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`,
            fields: [
                { name: "ë‚¨ì€ ì‹œê°„", value: `${Math.floor(remainingSeconds / 60)}ë¶„`, inline: true },
                { name: "ë³µê·€ ì˜ˆì • ì‹œê°", value: estimatedTimeStr, inline: true } // ğŸ‘ˆ ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œ
            ],
            footer: { text: `ì—°ì¥ ì‹œê°: ${timestamp}` }
        }]
    };

    fetch(DISCORD_WEBHOOK, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(embedData) });

    // 4. ê¸°ë¡ ì¶”ê°€
    addHistoryItem(statusData.nickname, `â³ ì‹œê°„ì„ ${min}ë¶„ ì—°ì¥í•¨ (ì˜ˆì •: ${targetHour}:${targetMin})`, timestamp);
}

    // ì§ì ‘ ì…ë ¥í•œ ê°’ìœ¼ë¡œ ì‹œê°„ì„ ì—°ì¥í•˜ëŠ” í•¨ìˆ˜
function extendDirect() {
    const min = document.getElementById('extend-direct-time').value;
    if (!min || min <= 0) {
        alert("ì—°ì¥í•  ì‹œê°„ì„ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        return;
    }
    extendTime(parseInt(min)); // ê¸°ì¡´ì— ë§Œë“  extendTime í•¨ìˆ˜ë¥¼ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤!
    document.getElementById('extend-direct-time').value = ""; // ì…ë ¥ì°½ ë¹„ìš°ê¸°
}

    async function askKyaru() {
    const inputField = document.getElementById('kyaru-input');
    const question = inputField.value.trim();
    const responseBox = document.getElementById('kyaru-response');
    const responseText = document.getElementById('kyaru-text');
    const loadingBox = document.getElementById('kyaru-loading'); // ë¡œë”© ë°•ìŠ¤ ê°€ì ¸ì˜¤ê¸°

    if (!question) return alert("ë°”ë³´ì•¼! ë¬¼ì–´ë³¼ ë§ì„ ì¨ì•¼ì§€!");

    // 1. UI ì´ˆê¸°í™”: ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ë³´ì—¬ì£¼ê³ , ì´ì „ ë‹µë³€ì€ ìˆ¨ê¸°ê¸°
    loadingBox.style.display = "block";
    responseBox.style.display = "none";
    inputField.value = "";

    try {
        const response = await fetch('/ask_kyaru', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: question,
                nickname: document.getElementById('nickname').value
            })
        });

        const data = await response.json();

        // 2. ë‹µë³€ ì™„ë£Œ: ë¡œë”© ìˆ¨ê¸°ê³ , ë‹µë³€ ë°•ìŠ¤ ë³´ì—¬ì£¼ê¸°
        loadingBox.style.display = "none";
        responseBox.style.display = "block";
        responseText.innerText = data.answer;

    } catch (error) {
        loadingBox.style.display = "none";
        responseBox.style.display = "block";
        responseText.innerText = "í¥! ì„œë²„ë‘ ì—°ê²°ì´ ì•ˆ ë˜ì–ì•„. ë„¤ê°€ ë­˜ ì˜ëª»í•œ ê±° ì•„ëƒ?";
        console.error("Error:", error);
    }
}

    // ëª¨ë‹¬ ì—´ê¸°
function openModal() {
    document.getElementById('guideModal').style.display = 'block';
}

// ëª¨ë‹¬ ë‹«ê¸°
function closeModal() {
    document.getElementById('guideModal').style.display = 'none';
}

// ëª¨ë‹¬ ë°”ê¹¥ ì˜ì—­ í´ë¦­ ì‹œ ë‹«ê¸°
window.onclick = function(event) {
    const modal = document.getElementById('guideModal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}

// 1. ëª¨ë‹¬ ì—´ê¸°
function openStatsModal() {
    const modal = document.getElementById('statsModal');
    if (modal) {
        modal.style.display = 'block';
        // ëª¨ë‹¬ì´ ì™„ì „íˆ í™”ë©´ì— ë‚˜íƒ€ë‚œ ë’¤ ê·¸ë˜í”„ë¥¼ ê·¸ë¦¬ë„ë¡ 0.1ì´ˆ ë’¤ ì‹¤í–‰
        setTimeout(drawChart, 100);
    }
}

// 2. ëª¨ë‹¬ ë‹«ê¸° (ì´ ë¶€ë¶„ì´ ì—†ê±°ë‚˜ ì´ë¦„ì´ í‹€ë ¤ì„œ ì—ëŸ¬ê°€ ë‚¬ë˜ ê±°ì•¼!)
function closeStatsModal() {
    const modal = document.getElementById('statsModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// 3. ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
function drawChart() {
    const stats = JSON.parse(localStorage.getItem('statusStats') || '{}');
    const labels = Object.keys(stats);
    const data = Object.values(stats);

    const canvas = document.getElementById('statsChart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');

    // ì´ë¯¸ ê·¸ë ¤ì§„ ì°¨íŠ¸ê°€ ìˆë‹¤ë©´ íŒŒê´´í•˜ê³  ìƒˆë¡œ ìƒì„± (ì¤‘ë³µ ë°©ì§€)
    if (myChart !== null) {
        myChart.destroy();
    }

    myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'ì‚¬ìš© íšŸìˆ˜',
                data: data,
                backgroundColor: 'rgba(88, 101, 242, 0.5)',
                borderColor: 'rgba(88, 101, 242, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            }
        }
    });
}



</script>
</body>
</html>